name: Build APK from Zip

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Auto-extract & locate project
      run: |
        # 1. Zip'i zorla Ã§Ä±kar (mutlak yol hatalarÄ±nÄ± yoksay)
        unzip -q -o download.zip 2>&1 || true
        
        # 2. EÄŸer tar.gz varsa onu da Ã§Ä±kar
        if [ -f "ultra-download-manager-complete.tar.gz" ]; then
          echo "ðŸ“¦ Nested tar.gz found, extracting..."
          tar -xzf ultra-download-manager-complete.tar.gz
        fi
        
        # 3. Otomatik proje dizinini bul (gradlew arayarak)
        PROJECT_DIR=$(find . -maxdepth 3 -type f -name "gradlew" -exec dirname {} \; | head -n 1)
        
        # 4. EÄŸer bulamazsan build.gradle ile dene
        if [ -z "$PROJECT_DIR" ]; then
          PROJECT_DIR=$(find . -maxdepth 3 -name "build.gradle" -exec grep -l "com.android.application" {} \; | xargs dirname | head -n 1)
        fi
        
        # 5. Hala bulamazsan hata ver
        if [ -z "$PROJECT_DIR" ]; then
          echo "âŒ Android project not found in:"
          find . -maxdepth 2 -type d
          exit 1
        fi
        
        echo "âœ… PROJECT_DIR=$PROJECT_DIR"
        echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
        
    - name: Show project structure
      run: |
        echo "ðŸ“‚ Project files:"
        ls -la ${{ env.PROJECT_DIR }}/
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Build APK
      run: |
        cd ${{ env.PROJECT_DIR }}
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace
        
    - name: Auto-find & upload APK
      run: |
        APK_PATH=$(find ${{ env.PROJECT_DIR }} -name "*.apk" -path "*/debug/*" | head -n 1)
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: ${{ env.APK_PATH }}
        retention-days: 7
        
